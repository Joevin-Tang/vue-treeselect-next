# è™šæ‹Ÿæ»šåŠ¨é…ç½®

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [VirtualList.vue](file://src/components/VirtualList.vue)
- [Menu.vue](file://src/components/Menu.vue)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js)
- [VirtualScroll.spec.js](file://test/unit/specs/VirtualScroll.spec.js)
- [LargeDataExample.vue](file://src/examples/LargeDataExample.vue)
- [OPTIMIZATION_SUMMARY.md](file://OPTIMIZATION_SUMMARY.md)
- [performance-test.html](file://performance-test.html)
- [package.json](file://package.json)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [è™šæ‹Ÿæ»šåŠ¨åŸç†](#è™šæ‹Ÿæ»šåŠ¨åŸç†)
3. [æ ¸å¿ƒé…ç½®](#æ ¸å¿ƒé…ç½®)
4. [ç»„ä»¶é›†æˆ](#ç»„ä»¶é›†æˆ)
5. [æ€§èƒ½ä¼˜åŒ–æ•ˆæœ](#æ€§èƒ½ä¼˜åŒ–æ•ˆæœ)
6. [CSSæ ·å¼é…ç½®](#cssæ ·å¼é…ç½®)
7. [æµè§ˆå™¨å…¼å®¹æ€§](#æµè§ˆå™¨å…¼å®¹æ€§)
8. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
9. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
10. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ç®€ä»‹

è™šæ‹Ÿæ»šåŠ¨ï¼ˆVirtual Scrollingï¼‰æ˜¯vue-treeselect-nextç»„ä»¶åº“ä¸ºå¤„ç†å¤§æ•°æ®é‡æ ‘å½¢é€‰æ‹©å™¨è€Œå®ç°çš„æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–åŠŸèƒ½ã€‚é€šè¿‡åªæ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„èŠ‚ç‚¹ï¼ˆçº¦20-30ä¸ªï¼‰ï¼Œè™šæ‹Ÿæ»šåŠ¨æŠ€æœ¯èƒ½å¤Ÿå¤§å¹…æå‡æ¸²æŸ“æ€§èƒ½ï¼Œç›¸æ¯”ä¼ ç»Ÿå…¨é‡æ¸²æŸ“æ–¹å¼ï¼Œæ€§èƒ½æå‡å¯è¾¾50-100å€ï¼Œå†…å­˜å ç”¨å‡å°‘75%ã€‚

### ä¸»è¦ä¼˜åŠ¿

- **æ¸²æŸ“é€Ÿåº¦æå‡**ï¼š50-100å€æ€§èƒ½æå‡
- **å†…å­˜å ç”¨å‡å°‘**ï¼š75%å†…å­˜èŠ‚çœ
- **æ»šåŠ¨æµç•…æ€§**ï¼šè¾¾åˆ°60fpsæ»šåŠ¨å¸§ç‡
- **å¤§æ•°æ®æ”¯æŒ**ï¼šè½»æ¾å¤„ç†1-2ä¸‡æ¡æ ‘å½¢æ•°æ®

## è™šæ‹Ÿæ»šåŠ¨åŸç†

è™šæ‹Ÿæ»šåŠ¨çš„æ ¸å¿ƒåŸç†æ˜¯å°†åºå¤§çš„æ ‘å½¢æ•°æ®è½¬æ¢ä¸ºæ‰å¹³åŒ–çš„åˆ—è¡¨ç»“æ„ï¼Œåœ¨å¯è§†åŒºåŸŸå†…è¿›è¡ŒåŠ¨æ€æ¸²æŸ“ã€‚

```mermaid
flowchart TD
A["åŸå§‹æ ‘å½¢æ•°æ®<br/>10,000+èŠ‚ç‚¹"] --> B["æ‰å¹³åŒ–å¤„ç†<br/>è½¬æ¢ä¸ºçº¿æ€§åˆ—è¡¨"]
B --> C["å¯è§†åŒºåŸŸè®¡ç®—<br/>ç¡®å®šå¯è§èŒƒå›´"]
C --> D["åŠ¨æ€æ¸²æŸ“<br/>åªæ¸²æŸ“å¯è§èŠ‚ç‚¹"]
D --> E["è™šæ‹ŸDOM<br/>é«˜æ•ˆæ›´æ–°"]
F["æ»šåŠ¨äº‹ä»¶"] --> G["æ›´æ–°èµ·å§‹ç´¢å¼•"]
G --> H["é‡æ–°è®¡ç®—å¯è§èŒƒå›´"]
H --> D
```

**å›¾è¡¨æ¥æº**
- [VirtualList.vue](file://src/components/VirtualList.vue#L37-L99)

### æ ¸å¿ƒç®—æ³•

è™šæ‹Ÿæ»šåŠ¨ç»„ä»¶å®ç°äº†ä»¥ä¸‹å…³é”®ç®—æ³•ï¼š

1. **æ‰å¹³åŒ–ç®—æ³•**ï¼šå°†æ ‘å½¢ç»“æ„è½¬æ¢ä¸ºçº¿æ€§åˆ—è¡¨
2. **å¯è§†åŒºåŸŸè®¡ç®—**ï¼šæ ¹æ®å®¹å™¨é«˜åº¦å’Œé€‰é¡¹é«˜åº¦è®¡ç®—å¯è§èŠ‚ç‚¹
3. **ç¼“å†²åŒºç®¡ç†**ï¼šç»´æŠ¤ä¸Šä¸‹ç¼“å†²åŒºæå‡ç”¨æˆ·ä½“éªŒ
4. **åŠ¨æ€å®šä½**ï¼šä½¿ç”¨CSS transformè¿›è¡Œé«˜æ•ˆå®šä½

**ç« èŠ‚æ¥æº**
- [VirtualList.vue](file://src/components/VirtualList.vue#L37-L99)

## æ ¸å¿ƒé…ç½®

### virtualScrollå±æ€§

å¯ç”¨è™šæ‹Ÿæ»šåŠ¨åŠŸèƒ½çš„å…³é”®å±æ€§ï¼š

```javascript
// å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
virtualScroll: {
  type: Boolean,
  default: false,
}
```

### optionHeightå±æ€§

è®¾ç½®æ¯ä¸ªé€‰é¡¹çš„é«˜åº¦ï¼Œè¿™æ˜¯è™šæ‹Ÿæ»šåŠ¨æ­£å¸¸å·¥ä½œçš„å¿…è¦æ¡ä»¶ï¼š

```javascript
// é€‰é¡¹é«˜åº¦é…ç½®
optionHeight: {
  type: Number,
  default: 40,
}
```

### é…ç½®ç»„åˆ

```vue
<treeselect
  :virtual-scroll="true"
  :option-height="40"
  :max-height="300"
  :default-expand-level="0"
/>
```

**ç« èŠ‚æ¥æº**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L644-L655)

## ç»„ä»¶é›†æˆ

### Menu.vueä¸­çš„é›†æˆ

Menuç»„ä»¶æ ¹æ®`virtualScroll` propè‡ªåŠ¨åˆ‡æ¢æ¸²æŸ“æ¨¡å¼ï¼š

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Menu as Menuç»„ä»¶
participant VirtualList as VirtualListç»„ä»¶
participant NormalList as æ­£å¸¸åˆ—è¡¨
User->>Menu : æ‰“å¼€èœå•
Menu->>Menu : æ£€æŸ¥virtualScrollå±æ€§
alt è™šæ‹Ÿæ»šåŠ¨å¯ç”¨
Menu->>VirtualList : æ¸²æŸ“VirtualListç»„ä»¶
VirtualList->>VirtualList : è®¡ç®—å¯è§èŠ‚ç‚¹
VirtualList-->>Menu : è¿”å›æ¸²æŸ“ç»“æœ
else è™šæ‹Ÿæ»šåŠ¨ç¦ç”¨
Menu->>NormalList : æ¸²æŸ“å®Œæ•´åˆ—è¡¨
NormalList-->>Menu : è¿”å›æ‰€æœ‰èŠ‚ç‚¹
end
Menu-->>User : æ˜¾ç¤ºèœå•å†…å®¹
```

**å›¾è¡¨æ¥æº**
- [Menu.vue](file://src/components/Menu.vue#L161-L176)

### æ¸²æŸ“é€»è¾‘

Menuç»„ä»¶çš„æ¸²æŸ“é€»è¾‘å¦‚ä¸‹ï¼š

```javascript
renderOptionList() {
  const { instance } = this
  
  // ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–å¤§æ•°æ®æ¸²æŸ“
  if (instance.virtualScroll) {
    return <VirtualList itemHeight={instance.optionHeight} />
  }
  
  // åŸæœ‰æ¸²æŸ“æ–¹å¼ï¼ˆå°æ•°æ®é‡ï¼‰
  return (
    <div class="vue-treeselect__list">
      {instance.forest.normalizedOptions.map(rootNode => (
        <Option node={rootNode} key={rootNode.id} />
      ))}
    </div>
  )
}
```

**ç« èŠ‚æ¥æº**
- [Menu.vue](file://src/components/Menu.vue#L161-L176)

## æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½å¯¹æ¯”æ•°æ®

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å€æ•° |
|------|--------|--------|----------|
| åˆå§‹åŒ–æ—¶é—´ | 3500ms | 600ms | **5.8x** âš¡ |
| é¦–æ¬¡æ¸²æŸ“ | 2800ms | 50ms | **56x** ğŸš€ |
| æœç´¢å“åº” | 800ms | 120ms | **6.7x** âš¡ |
| å†…å­˜å ç”¨ | 180MB | 45MB | **4x** ğŸ’¾ |
| æ»šåŠ¨å¸§ç‡ | 15fps | 60fps | **4x** ğŸ® |
| DOMèŠ‚ç‚¹æ•° | 10000+ | ~30 | **333x** ğŸ“‰ |

### ä¼˜åŒ–åŸç†

```mermaid
graph LR
A["å¤§æ•°æ®é—®é¢˜"] --> B["å…¨é‡DOMæ¸²æŸ“"]
A --> C["è¿‡å¤šå“åº”å¼å±æ€§"]
A --> D["é¢‘ç¹æ ‘éå†"]
E["è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–"] --> F["åªæ¸²æŸ“å¯è§èŠ‚ç‚¹"]
E --> G["å‡å°‘DOMèŠ‚ç‚¹"]
E --> H["æå‡æ¸²æŸ“æ•ˆç‡"]
B --> F
C --> G
D --> H
```

**å›¾è¡¨æ¥æº**
- [OPTIMIZATION_SUMMARY.md](file://OPTIMIZATION_SUMMARY.md#L242-L262)

**ç« èŠ‚æ¥æº**
- [OPTIMIZATION_SUMMARY.md](file://OPTIMIZATION_SUMMARY.md#L149-L161)

## CSSæ ·å¼é…ç½®

### å¿…éœ€çš„CSSè§„åˆ™

ç¡®ä¿é€‰é¡¹çš„å®é™…é«˜åº¦ä¸`option-height`å±æ€§ä¿æŒä¸€è‡´ï¼š

```css
.vue-treeselect__option {
  height: 40px;        /* ä¸ option-height ä¸€è‡´ */
  line-height: 40px;
  overflow: hidden;
}

.vue-treeselect__list-item {
  /* ç¡®ä¿åˆ—è¡¨é¡¹é«˜åº¦ä¸€è‡´ */
  height: 40px;
  display: flex;
  align-items: center;
}
```

### è™šæ‹Ÿæ»šåŠ¨ä¸“ç”¨æ ·å¼

```css
.vue-treeselect__virtual-list-container {
  overflow-x: hidden;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.vue-treeselect__virtual-list-spacer {
  position: relative;
}

.vue-treeselect__virtual-list-items {
  will-change: transform;
}
```

**ç« èŠ‚æ¥æº**
- [VirtualList.vue](file://src/components/VirtualList.vue#L192-L206)

## æµè§ˆå™¨å…¼å®¹æ€§

### ç°ä»£æµè§ˆå™¨æ”¯æŒ

è™šæ‹Ÿæ»šåŠ¨åŠŸèƒ½ä¾èµ–ä»¥ä¸‹ç°ä»£æµè§ˆå™¨ç‰¹æ€§ï¼š

| ç‰¹æ€§ | æœ€ä½ç‰ˆæœ¬ | æ”¯æŒæƒ…å†µ |
|------|----------|----------|
| ResizeObserver | Chrome 64+, Firefox 69+ | âœ… å®Œå…¨æ”¯æŒ |
| CSS Transform | IE11+ | âœ… å®Œå…¨æ”¯æŒ |
| Passive Event Listeners | Chrome 51+, Firefox 49+ | âœ… å®Œå…¨æ”¯æŒ |

### IE11å…¼å®¹æ€§

**âš ï¸ IE11æ³¨æ„äº‹é¡¹**ï¼š
- éœ€è¦ResizeObserver polyfillæ”¯æŒ
- å»ºè®®ä½¿ç”¨`resize-observer-polyfill`åŒ…
- å¯¹äºå…¶ä»–æµè§ˆå™¨ï¼Œç»„ä»¶ä¼šè‡ªåŠ¨é™çº§å¤„ç†

### å…¼å®¹æ€§æ£€æµ‹

```javascript
// è™šæ‹Ÿæ»šåŠ¨ç»„ä»¶å†…éƒ¨çš„å…¼å®¹æ€§æ£€æŸ¥
mounted() {
  this.$nextTick(() => {
    this.isMounted = true
    this.updateContainerHeight()
    // ç›‘å¬å®¹å™¨å¤§å°å˜åŒ–
    if (typeof ResizeObserver !== 'undefined') {
      this.resizeObserver = new ResizeObserver(this.updateContainerHeight)
      this.resizeObserver.observe(this.$refs.container)
    }
  })
}
```

**ç« èŠ‚æ¥æº**
- [VirtualList.vue](file://src/components/VirtualList.vue#L114-L117)

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€é…ç½®ç¤ºä¾‹

```vue
<template>
  <treeselect
    v-model="value"
    :options="largeOptions"
    :multiple="true"
    :virtual-scroll="true"
    :option-height="40"
    :max-height="300"
    :default-expand-level="0"
    placeholder="é€‰æ‹©é€‰é¡¹..."
  />
</template>

<script>
export default {
  data() {
    return {
      value: [],
      largeOptions: [] // 1-2ä¸‡æ¡æ ‘å½¢æ•°æ®
    }
  }
}
</script>
</template>
```

### é«˜çº§é…ç½®ç¤ºä¾‹

```vue
<template>
  <treeselect
    v-model="value"
    :options="options"
    :multiple="true"
    :virtual-scroll="true"
    :option-height="40"
    :max-height="300"
    :default-expand-level="0"
    :flatten-search-results="true"
    :show-count="false"
    :disable-fuzzy-matching="true"
    :cache-options="true"
    placeholder="å¤§æ•°æ®é‡é€‰æ‹©å™¨"
  />
</template>
```

**ç« èŠ‚æ¥æº**
- [LargeDataExample.vue](file://src/examples/LargeDataExample.vue#L23-L37)

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è™šæ‹Ÿæ»šåŠ¨æœªç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šç»„ä»¶ä»ç„¶æ¸²æŸ“æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ€§èƒ½æ²¡æœ‰æ”¹å–„

**åŸå› **ï¼šç¼ºå°‘å¿…è¦çš„é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// ç¡®ä¿è®¾ç½®äº†è¿™ä¸¤ä¸ªå…³é”®å±æ€§
:virtual-scroll="true"
:option-height="40"
```

#### 2. é€‰é¡¹é«˜åº¦ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼šæ»šåŠ¨æ—¶å‡ºç°ç©ºç™½æˆ–é‡å ç°è±¡

**åŸå› **ï¼šCSSé«˜åº¦ä¸option-heightä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š
```css
.vue-treeselect__option {
  height: 40px !important;
  line-height: 40px;
}
```

#### 3. æœç´¢ç»“æœæ˜¾ç¤ºä¸å®Œæ•´

**ç—‡çŠ¶**ï¼šæœç´¢ç»“æœä¸­æŸäº›èŠ‚ç‚¹ä¸å¯è§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
:flatten-search-results="true"
```

#### 4. æ»šåŠ¨æ—¶æœ‰é—ªçƒ

**ç—‡çŠ¶**ï¼šæ»šåŠ¨è¿‡ç¨‹ä¸­ç•Œé¢é—ªçƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿CSSé«˜åº¦è®¾ç½®æ­£ç¡®
- æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨æ€é«˜åº¦çš„å…ƒç´ 
- ä½¿ç”¨`will-change: transform`ä¼˜åŒ–

**ç« èŠ‚æ¥æº**
- [VirtualScroll.spec.js](file://test/unit/specs/VirtualScroll.spec.js#L366-L379)

## æœ€ä½³å®è·µ

### æ¨èé…ç½®

#### å°æ•°æ®é‡ (< 1000æ¡)
```javascript
:virtual-scroll="false"
:default-expand-level="1"
:show-count="true"
```

#### ä¸­ç­‰æ•°æ®é‡ (1000-5000æ¡)
```javascript
:virtual-scroll="true"
:default-expand-level="0"
:show-count="false"
```

#### å¤§æ•°æ®é‡ (> 5000æ¡)
```javascript
:virtual-scroll="true"
:default-expand-level="0"
:flatten-search-results="true"
:show-count="false"
:disable-fuzzy-matching="true"
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å›ºå®šé«˜åº¦é€‰é¡¹**ï¼šç¡®ä¿æ‰€æœ‰é€‰é¡¹é«˜åº¦ä¸€è‡´
2. **åˆç†å±•å¼€å±‚çº§**ï¼šè®¾ç½®`default-expand-level="0"`
3. **ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½**ï¼šå…³é—­è®¡æ•°ã€æ¨¡ç³ŠåŒ¹é…ç­‰
4. **å¯ç”¨æœç´¢ç¼“å­˜**ï¼šä½¿ç”¨`cache-options="true"`
5. **æ‰å¹³åŒ–æœç´¢**ï¼šå¯ç”¨`flatten-search-results`

### ç›‘æ§å’Œè°ƒè¯•

```javascript
// æ€§èƒ½ç›‘æ§ç¤ºä¾‹
mounted() {
  this.performanceMonitor = {
    renderTime: 0,
    memoryUsage: 0,
    scrollEvents: 0
  }
}

methods: {
  onMenuOpen() {
    this.renderStartTime = performance.now()
  },
  
  onMenuClose() {
    const renderTime = performance.now() - this.renderStartTime
    console.log('é¦–æ¬¡æ¸²æŸ“è€—æ—¶:', renderTime, 'ms')
  }
}
```

**ç« èŠ‚æ¥æº**
- [OPTIMIZATION_SUMMARY.md](file://OPTIMIZATION_SUMMARY.md#L296-L320)

## ç»“è®º

è™šæ‹Ÿæ»šåŠ¨åŠŸèƒ½æ˜¯vue-treeselect-nextå¤„ç†å¤§æ•°æ®é‡çš„æ ¸å¿ƒè§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æ­£ç¡®çš„é…ç½®å’Œä¼˜åŒ–ï¼Œå¯ä»¥å°†åŸæœ¬å¡é¡¿çš„æ ‘å½¢é€‰æ‹©å™¨è½¬å˜ä¸ºæµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œæ”¯æŒ1-2ä¸‡æ¡æ•°æ®çš„æ— ç¼æ“ä½œã€‚å¼€å‘è€…åº”å½“æ ¹æ®å…·ä½“çš„æ•°æ®é‡å’Œä½¿ç”¨åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„é…ç½®ç­–ç•¥ï¼Œä»¥è·å¾—æœ€ä½³çš„æ€§èƒ½è¡¨ç°ã€‚