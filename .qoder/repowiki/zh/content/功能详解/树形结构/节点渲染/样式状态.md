# 样式状态

<cite>
**本文档中引用的文件**  
- [Option.vue](file://src/components/Option.vue)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js)
- [constants.js](file://src/constants.js)
</cite>

## 目录
1. [简介](#简介)
2. [CSS类名动态绑定策略](#css类名动态绑定策略)
3. [状态控制计算属性](#状态控制计算属性)
4. [状态联动与实例管理](#状态联动与实例管理)
5. [自定义样式与覆盖建议](#自定义样式与覆盖建议)
6. [结论](#结论)

## 简介
Vue Treeselect组件中的Option组件通过动态CSS类名实现丰富的视觉状态反馈。本文档深入解析`vue-treeselect__option--selected`（选中状态）、`vue-treeselect__option--highlight`（高亮状态）、`vue-treeselect__option--disabled`（禁用状态）和`vue-treeselect__option--matched`（搜索匹配状态）的触发条件和视觉表现机制。这些状态通过计算属性和实例方法进行控制，并与Treeselect实例的状态管理机制紧密联动。

## CSS类名动态绑定策略

Option组件通过`renderOption`方法中的`optionClass`对象实现CSS类名的动态绑定，根据不同的状态条件添加相应的类名：

```javascript
const optionClass = {
  'vue-treeselect__option': true,
  'vue-treeselect__option--disabled': node.isDisabled,
  'vue-treeselect__option--selected': instance.isSelected(node),
  'vue-treeselect__option--highlight': node.isHighlighted,
  'vue-treeselect__option--matched': instance.localSearch.active && node.isMatched,
  'vue-treeselect__option--hide': !this.shouldShow,
}
```

**各状态类名的触发条件：**

- **选中状态 (vue-treeselect__option--selected)**：当`instance.isSelected(node)`返回`true`时触发，表示该选项当前被选中。
- **高亮状态 (vue-treeselect__option--highlight)**：当`node.isHighlighted`为`true`时触发，表示该选项是当前键盘导航或鼠标悬停的目标。
- **禁用状态 (vue-treeselect__option--disabled)**：当`node.isDisabled`为`true`时触发，表示该选项不可交互。
- **搜索匹配状态 (vue-treeselect__option--matched)**：当`instance.localSearch.active`（本地搜索激活）且`node.isMatched`（节点匹配搜索）时触发。
- **隐藏状态 (vue-treeselect__option--hide)**：当`!this.shouldShow`为`true`时触发，表示该选项不应在菜单中显示。

**状态表现：**
- 选中状态通常通过背景色变化和选中图标来视觉化
- 高亮状态通过悬停效果或键盘焦点样式体现
- 禁用状态通过灰色文本和禁止光标显示
- 搜索匹配状态通过高亮匹配文本或特殊边框标识

**Section sources**
- [Option.vue](file://src/components/Option.vue#L37-L44)

## 状态控制计算属性

Option组件的状态控制主要依赖于`shouldShow`计算属性，而`isSelected`和`isHighlighted`状态则由Treeselect实例直接管理。

### shouldShow 计算属性

`shouldShow`是Option组件的核心计算属性，它决定了选项是否应该在菜单中显示：

```javascript
computed: {
  shouldShow() {
    const { instance, node } = this
    return instance.shouldShowOptionInMenu(node)
  },
}
```

该属性通过调用Treeselect实例的`shouldShowOptionInMenu`方法来确定显示逻辑。当搜索激活时，只有匹配的选项或包含匹配后代的分支节点才会显示。

### isSelected 状态控制

`isSelected`状态由Treeselect实例的`isSelected`方法控制，该方法检查节点ID是否存在于`forest.selectedNodeIds`数组中：

```javascript
isSelected(node) {
  return this.forest.selectedNodeMap[node.id] === true
}
```

该方法通过`forest.selectedNodeMap`映射对象实现O(1)时间复杂度的快速查找，确保选中状态检查的高效性。

### isHighlighted 状态控制

`isHighlighted`状态通过`setCurrentHighlightedOption`方法进行管理，该方法更新`menu.current`属性并同步`node.isHighlighted`标志：

```javascript
setCurrentHighlightedOption(node, scroll = true) {
  const { id } = node
  this.menu.current = id
  // ...滚动逻辑
}
```

当选项获得高亮时，`node.isHighlighted`被设置为`true`；当失去高亮时，被设置为`false`。

**Section sources**
- [Option.vue](file://src/components/Option.vue#L27-L31)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1705-L1738)

## 状态联动与实例管理

Option组件的状态管理与Treeselect实例深度集成，通过`inject: [ 'instance' ]`注入实例引用，实现状态的统一管理。

### 搜索状态联动

搜索功能通过`localSearch`数据对象管理，包含`active`（搜索激活状态）和`noResults`（无结果状态）等属性：

```javascript
data() {
  return {
    localSearch: {
      active: false,
      noResults: true,
      countMap: createMap(),
    },
  }
}
```

当用户输入搜索查询时，`handleLocalSearch`方法被调用，更新`localSearch.active`状态并执行匹配逻辑：

```javascript
handleLocalSearch() {
  const { searchQuery } = this.trigger
  this.localSearch.active = searchQuery !== ''
  // ...匹配逻辑
}
```

### 高亮状态管理

高亮状态的管理涉及多个方法的协同工作：

- `setCurrentHighlightedOption`：设置当前高亮选项
- `resetHighlightedOptionWhenNecessary`：在必要时重置高亮状态
- `highlightFirstOption`、`highlightPrevOption`、`highlightNextOption`：导航方法

这些方法确保在菜单打开、搜索条件变化或选项列表更新时，总有一个合适的选项处于高亮状态。

### 选中状态同步

选中状态通过`select`方法进行管理，该方法处理单选和多选模式下的选中逻辑：

```javascript
select(node) {
  if (this.disabled || node.isDisabled) {
    return
  }
  // ...选中/取消选中逻辑
  this.buildForestState()
}
```

`buildForestState`方法负责更新`forest.checkedStateMap`和`forest.selectedNodeMap`，确保所有相关状态的同步。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L695-L702)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1416-L1426)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L2049-L2083)

## 自定义样式与覆盖建议

### CSS覆盖策略

要自定义Option组件的样式，建议使用更具体的选择器来覆盖默认样式：

```css
/* 自定义选中状态 */
.vue-treeselect__option--selected {
  background-color: #007bff;
  color: white;
}

/* 自定义高亮状态 */
.vue-treeselect__option--highlight {
  background-color: #e3f2fd;
  border-left: 3px solid #2196f3;
}

/* 自定义禁用状态 */
.vue-treeselect__option--disabled {
  color: #9e9e9e;
  cursor: not-allowed;
  opacity: 0.6;
}

/* 自定义匹配状态 */
.vue-treeselect__option--matched {
  border: 1px solid #ffeb3b;
  background-color: #fffde7;
}
```

### 最佳实践

1. **使用深度选择器**：在使用scoped CSS时，使用`>>>`或`::v-deep`穿透作用域：

```vue
<style scoped>
.vue-treeselect >>> .vue-treeselect__option--selected {
  background-color: #007bff;
}
</style>
```

2. **主题化设计**：创建可复用的主题变量，便于统一管理：

```css
:root {
  --option-selected-bg: #007bff;
  --option-highlight-bg: #e3f2fd;
  --option-disabled-color: #9e9e9e;
}

.vue-treeselect__option--selected {
  background-color: var(--option-selected-bg);
}
```

3. **响应式设计**：考虑不同设备下的视觉表现：

```css
@media (max-width: 768px) {
  .vue-treeselect__option {
    padding: 12px 16px;
    font-size: 16px;
  }
}
```

4. **无障碍访问**：确保状态变化对辅助技术可见：

```css
.vue-treeselect__option--selected {
  outline: 2px solid #007bff;
  outline-offset: -2px;
}
```

**Section sources**
- [Option.vue](file://src/components/Option.vue#L38-L43)

## 结论

Vue Treeselect的Option组件通过精心设计的CSS类名动态绑定策略，实现了丰富的视觉状态反馈。`vue-treeselect__option--selected`、`vue-treeselect__option--highlight`、`vue-treeselect__option--disabled`和`vue-treeselect__option--matched`等状态类名通过计算属性和实例方法进行精确控制，确保了状态的一致性和可预测性。

`shouldShow`计算属性作为显示逻辑的核心，与`isSelected`和`isHighlighted`状态共同构成了完整的状态管理体系。这些状态与Treeselect实例的状态管理机制紧密联动，通过`localSearch`、`menu`和`forest`等数据对象实现跨组件的状态同步。

在自定义样式时，建议使用具体的选择器、主题变量和深度选择器来安全地覆盖默认样式，同时考虑响应式设计和无障碍访问需求。通过理解这些状态的触发条件和控制机制，开发者可以创建出既美观又功能完善的下拉选择组件。