# 基础选择

<cite>
**本文档引用文件**   
- [Treeselect.vue](file://src/components/Treeselect.vue)
- [Control.vue](file://src/components/Control.vue)
- [MultiValue.vue](file://src/components/MultiValue.vue)
- [SingleValue.vue](file://src/components/SingleValue.vue)
- [Input.vue](file://src/components/Input.vue)
- [HiddenFields.vue](file://src/components/HiddenFields.vue)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js)
</cite>

## 目录
1. [单选与多选模式实现机制](#单选与多选模式实现机制)
2. [v-model数据绑定行为](#v-model数据绑定行为)
3. [Control组件与输入区域渲染](#control组件与输入区域渲染)
4. [MultiValue与SingleValue组件职责](#multivalue与singlevalue组件职责)
5. [核心计算属性与状态管理](#核心计算属性与状态管理)
6. [选中状态更新流程](#选中状态更新流程)
7. [值格式化与边界情况处理](#值格式化与边界情况处理)

## 单选与多选模式实现机制

单选与多选模式的实现主要通过`multiple`属性控制。当`multiple`为`false`时，组件处于单选模式；当`multiple`为`true`时，组件处于多选模式。组件通过`internalValue`计算属性来管理选中值的状态，该属性会根据`valueConsistsOf`属性的不同配置（如`BRANCH_PRIORITY`、`LEAF_PRIORITY`等）来决定最终返回的值。

在单选模式下，`internalValue`直接返回选中节点的ID；在多选模式下，`internalValue`会根据`valueConsistsOf`的配置过滤和排序选中的节点ID。`multiple`属性的变化会触发`multiple`监听器，重新构建森林状态。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L392-L395)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L862-L867)

## v-model数据绑定行为

v-model的实现基于`value`属性和`input`事件。`value`属性接收外部传入的值，`internalValue`计算属性根据`valueFormat`（`id`或`object`）解析`value`属性，将其转换为内部使用的节点ID数组。当用户选择或取消选择节点时，组件会通过`$emit('input', ...)`触发`input`事件，将最新的值传递给父组件，从而实现双向数据绑定。

`internalValue`的变化会触发`internalValue`监听器，当新旧值不同时，会发出`input`事件。`getValue()`方法根据`valueFormat`和`multiple`属性返回适当格式的值。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L602-L603)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L722-L758)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L850-L855)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L977-L979)

## Control组件与输入区域渲染

Control组件负责协调输入区域的渲染。它根据`single`计算属性的值，动态决定渲染`SingleValue`还是`MultiValue`组件。`render()`方法中使用`instance.single ? SingleValue : MultiValue`来实现组件的条件渲染。

Control组件还负责渲染清除按钮（×）和下拉箭头，这些元素的显示与否由`shouldShowX`和`shouldShowArrow`计算属性控制。`renderValueContainer`方法提供了一个渲染插槽，供`SingleValue`和`MultiValue`组件使用。

**Section sources**
- [Control.vue](file://src/components/Control.vue#L142-L145)
- [Control.vue](file://src/components/Control.vue#L18-L27)
- [Control.vue](file://src/components/Control.vue#L33-L40)

## MultiValue与SingleValue组件职责

### MultiValue组件职责
`MultiValue`组件在多选模式下负责渲染多个选中值。它通过`renderMultiValueItems`方法遍历`internalValue`，为每个选中节点创建`MultiValueItem`组件。它还负责渲染超出限制的提示信息和输入框。`MultiValue`组件使用`transition-group`来实现选中项的动画效果。

### SingleValue组件职责
`SingleValue`组件在单选模式下负责渲染单个选中值。它通过`renderSingleValueLabel`方法获取选中节点的标签文本，并将其渲染在`.vue-treeselect__single-value`容器中。当有值且没有搜索查询时，才会显示选中值。

**Section sources**
- [MultiValue.vue](file://src/components/MultiValue.vue#L14-L19)
- [MultiValue.vue](file://src/components/MultiValue.vue#L47-L51)
- [SingleValue.vue](file://src/components/SingleValue.vue#L11-L16)
- [SingleValue.vue](file://src/components/SingleValue.vue#L24-L27)

## 核心计算属性与状态管理

### value与internalValue
`value`是外部传入的prop，表示组件的当前值。`internalValue`是一个核心计算属性，它基于`forest.selectedNodeIds`（内部选中节点ID列表），并根据`single`、`flat`、`disableBranchNodes`和`valueConsistsOf`等配置进行过滤和排序，最终生成对外输出的值列表。`internalValue`是`v-model`数据绑定的实际来源。

### 状态管理
组件使用`data`选项中的`forest`对象来管理复杂的内部状态，包括：
- `selectedNodeIds`: 选中节点的ID列表
- `nodeMap`: 节点ID到节点对象的映射，用于快速查找
- `checkedStateMap`: 节点ID到其选中状态（选中、未选中、半选）的映射
- `selectedNodeMap`: 选中节点ID到`true`的映射，用于快速判断节点是否被选中

`buildForestState()`方法负责根据当前选中状态更新这些映射。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L686-L689)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L722-L758)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1504-L1529)

## 选中状态更新流程

选中状态的更新流程始于`select(node)`方法。该方法首先检查组件是否禁用或节点是否被禁用。在单选模式下，会先调用`clear()`清空现有选择。

然后，根据`nextState`（节点的下一个状态）决定是调用`_selectNode(node)`还是`_deselectNode(node)`。`_selectNode`和`_deselectNode`方法会递归地处理分支节点的后代和祖先，以实现级联选择/取消选择的逻辑。

最后，调用`buildForestState()`更新所有内部状态映射，并发出`select`或`deselect`事件。如果需要，还会重置搜索查询或关闭菜单。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1784-L1837)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1839-L1932)

## 值格式化与边界情况处理

### 值格式化（valueFormat）
`valueFormat`属性决定了`value` prop和`input`事件的值的格式。当`valueFormat`为`"id"`时，值是节点ID的字符串或数组；当为`"object"`时，值是包含`id`和`label`等属性的节点对象或对象数组。`extractCheckedNodeIdsFromValue()`方法负责根据`valueFormat`从`value` prop中提取节点ID。

### 边界情况处理
组件通过多种机制处理边界情况：
- **重复ID检查**：`checkDuplication()`方法在规范化节点时发出警告，防止ID重复。
- **异步加载**：`loadRootOptions()`和`loadChildrenOptions()`方法处理根节点和子节点的异步加载。
- **空值处理**：`hasValue`计算属性用于判断是否有值被选中，并据此显示占位符或清除按钮。
- **禁用节点处理**：`allowClearingDisabled`和`allowSelectingDisabledDescendants`等属性提供了对禁用节点的特殊处理逻辑。
- **防抖搜索**：`Input.vue`组件使用`debounce`函数对本地搜索进行防抖，优化性能。

**Section sources**
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1024-L1033)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1768-L1773)
- [Input.vue](file://src/components/Input.vue#L54-L58)
- [treeselectMixin.js](file://src/mixins/treeselectMixin.js#L1217-L1280)